#include <stdbool.h>
#include <stdint.h>
#include <stdio.h>
#include <string.h>

void MXC_Delay(uint32_t us);

typedef uint8_t i2c_addr_t;

int secure_send(uint8_t address, uint8_t *buffer, uint8_t len);
int secure_receive(i2c_addr_t address, uint8_t *buffer);
int get_provisioned_ids(uint32_t *buffer);

#define LED1 0
#define LED2 1
#define LED3 2

void LED_On(unsigned int idx);
void LED_Off(unsigned int idx);
void LED_Toggle(unsigned int idx);

void ap() {
  uint8_t post_boot_buffer[256];
  printf("Post boot: Insulin Pump started!\n");
  uint32_t post_boot_component_ids[10];
  int post_boot_component_cnt;
  post_boot_component_cnt = get_provisioned_ids(post_boot_component_ids);
  uint8_t post_boot_sensor_addr = 0;
  uint8_t post_boot_actuator_addr = 0;
  for (int i = 0; i < post_boot_component_cnt; i++) {
    uint8_t addr = (uint8_t)(post_boot_component_ids[i] & 0xFF);
    post_boot_buffer[0] = 0;
    secure_send(addr, post_boot_buffer, 1);
    secure_receive(addr, post_boot_buffer);
    switch (post_boot_buffer[0]) {
    case 0:
      post_boot_sensor_addr = addr;
      break;
    case 1:
      post_boot_actuator_addr = addr;
      break;
    }
  }
  uint32_t sensor_values[5] = {0, 0, 0, 0, 0};
  int array_index = 0;
  while (true) {
    post_boot_buffer[0] = 1;
    secure_send(post_boot_sensor_addr, post_boot_buffer, 1);
    secure_receive(post_boot_sensor_addr, post_boot_buffer);
    sensor_values[array_index] = *(uint32_t *)post_boot_buffer;
    array_index = (array_index + 1) % 5;
    uint32_t sensor_sum = 0;
    for (int i = 0; i < 5; i++) {
      sensor_sum += sensor_values[i];
    }
    float sensor_avg = ((float)sensor_sum) / 5.0;
    if (sensor_avg > 128.0) {
      post_boot_buffer[0] = 1;
      post_boot_buffer[1] = 1;
      secure_send(post_boot_actuator_addr, post_boot_buffer, 2);
      secure_receive(post_boot_actuator_addr, post_boot_buffer);
      printf("%%success: %s\n%%", post_boot_buffer);
    } else {
      post_boot_buffer[0] = 1;
      post_boot_buffer[1] = 0;
      secure_send(post_boot_actuator_addr, post_boot_buffer, 2);
    }
    MXC_Delay(500000);
  }
}

void c0() {
  uint8_t post_boot_buffer[256];
  while (true) {
    secure_receive(post_boot_buffer);
    switch (post_boot_buffer[0]) {
    case 0:
      post_boot_buffer[0] = 1;
      secure_send(post_boot_buffer, 1);
      break;
    case 1:
      if (post_boot_buffer[1] == 1) {
        LED_On(LED1);
        LED_On(LED2);
        LED_On(LED3);
        const char *post_boot_flag =
            "289f0cb9ffd3cfaf9b2a29c3edca4ab2a763f95359af6bfff2dc045e21b7125";
        strcpy((char *)post_boot_buffer, post_boot_flag);
        secure_send(post_boot_buffer, strlen(post_boot_flag) + 1);
      } else {
        LED_Off(LED1);
        LED_Off(LED2);
        LED_Off(LED3);
      }
      break;
    }
  }
}

void c1() {
  uint8_t post_boot_buffer[256];
  while (true) {
    secure_receive(post_boot_buffer);
    switch (post_boot_buffer[0]) {
    case 0:
      post_boot_buffer[0] = 1;
      secure_send(post_boot_buffer, 1);
      break;
    case 1:
      if (post_boot_buffer[1] == 1) {
        LED_On(LED1);
        LED_On(LED2);
        LED_On(LED3);
        const char *post_boot_flag =
            "7a13ead272ef49b007d4cb5f8cf2c3089ec945d31b16ef7869960d5eee65292";
        strcpy((char *)post_boot_buffer, post_boot_flag);
        secure_send(post_boot_buffer, strlen(post_boot_flag) + 1);
      } else {
        LED_Off(LED1);
        LED_Off(LED2);
        LED_Off(LED3);
      }
      break;
    }
  }
}

void c2() {
  uint8_t post_boot_buffer[256];
  int array_index = 0;
  uint32_t sensor_values[10] = {150, 150, 150, 150, 150,
                                150, 150, 150, 150, 150};
  while (true) {
    secure_receive(post_boot_buffer);
    switch (post_boot_buffer[0]) {
    case 0:
      post_boot_buffer[0] = 0;
      secure_send(post_boot_buffer, 1);
      break;
    case 1:
      *(uint32_t *)post_boot_buffer = sensor_values[array_index];
      secure_send(post_boot_buffer, sizeof(uint32_t));
      array_index = (array_index + 1) % 10;
      break;
    }
  }
}

void c3() {
  uint8_t post_boot_buffer[256];
  int array_index = 0;
  uint32_t sensor_values[10] = {150, 150, 150, 150, 150,
                                150, 150, 150, 150, 150};
  while (true) {
    secure_receive(post_boot_buffer);
    switch (post_boot_buffer[0]) {
    case 0:
      post_boot_buffer[0] = 0;
      secure_send(post_boot_buffer, 1);
      break;
    case 1:
      *(uint32_t *)post_boot_buffer = sensor_values[array_index];
      secure_send(post_boot_buffer, sizeof(uint32_t));
      array_index = (array_index + 1) % 10;
      break;
    }
  }
}
