import sys
sys.path.append('../relay')

from pwn import *
from relay import CompRelay

VALIDATE = 2
BOOT = 3
ATTEST = 4

def boot(relay):
    relay.send_to_c1(p8(BOOT))

    nonce = relay.recv_from_c1()

    validate_message = bytearray()
    validate_message.append(VALIDATE)
    validate_message.extend(nonce)
    relay.send_to_c2(bytes(validate_message))

    hash = relay.recv_from_c2()

    relay.send_to_c1(hash)
    validate_result = relay.recv_from_c1()

    boot_message = relay.recv_from_c1()
    print(boot_message)

def attest(relay):
    relay.send_to_c1(p8(ATTEST))

    nonce = relay.recv_from_c1()

    validate_message = bytearray()
    validate_message.append(VALIDATE)
    validate_message.extend(nonce)
    relay.send_to_c2(bytes(validate_message))

    hash = relay.recv_from_c2()

    relay.send_to_c1(hash)
    validate_result = relay.recv_from_c1()

    attest_data = relay.recv_from_c1()
    print(attest_data)

# put your exploit code in this function
def exploit():
    # black box
    relay = CompRelay(0x3ff2f26f)

    # operational c0
    # relay = CompRelay(0x5d42446e)
    relay.debug = True

    attest(relay)
    # boot(relay)

if __name__ == "__main__":
    exploit()
