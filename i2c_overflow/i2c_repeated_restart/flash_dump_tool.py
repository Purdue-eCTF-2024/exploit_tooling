import argparse
import serial

# Main function
def main():
    parser = argparse.ArgumentParser(
        prog="b01lers flash dump tool",
        description="dumps the bytes printed out by shellcode on a component to a file",
    )

    parser.add_argument(
        "-c", "--component", required=True, help="Serial device of component with shellcode that will print out the flash"
    )

    parser.add_argument(
        "-o", "--out-file", required=True, help="File name to put flash dump into"
    )

    args = parser.parse_args()

    ser = serial.Serial(
        port=args.component,
        baudrate=115200,
        parity=serial.PARITY_NONE,
        stopbits=serial.STOPBITS_ONE,
        bytesize=serial.EIGHTBITS,
    )

    with open(args.out_file, 'wb') as f:
        message_printed = False
        dump_length = 0x00038000
        i = 0

        while i < dump_length:
            data = ser.read()
            i += len(data)

            if not message_printed:
                print("first few bytes recieved from component")
                message_printed = True

            f.write(data)

if __name__ == "__main__":
    main()

